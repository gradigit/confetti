name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Build universal binary
        run: swift build -c release --arch arm64 --arch x86_64

      - name: Determine version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Create tarball
        run: |
          mkdir -p staging
          cp .build/apple/Products/Release/confetti staging/
          cd staging
          tar -czf ../confetti-${{ steps.version.outputs.version }}.tar.gz confetti

      - name: Compute SHA256
        id: sha256
        run: |
          echo "hash=$(shasum -a 256 confetti-${{ steps.version.outputs.version }}.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: confetti-${{ steps.version.outputs.version }}.tar.gz
          generate_release_notes: true

      # Uncomment the step below to auto-update the Homebrew tap formula on each release.
      # Requires a Personal Access Token with `repo` scope stored as HOMEBREW_TAP_TOKEN:
      #   1. Create a PAT at https://github.com/settings/tokens (classic, repo scope)
      #   2. Add it as a repository secret: Settings > Secrets > Actions > HOMEBREW_TAP_TOKEN
      #
      # - name: Update Homebrew formula
      #   uses: mislav/bump-homebrew-formula-action@v3
      #   with:
      #     formula-name: confetti
      #     homebrew-tap: gradigit/homebrew-tap
      #     base-branch: main
      #     download-url: https://github.com/gradigit/confetti/releases/download/${{ github.ref_name }}/confetti-${{ steps.version.outputs.version }}.tar.gz
      #   env:
      #     COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
